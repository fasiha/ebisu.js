"use strict";var ebisu=(()=>{var V=Object.defineProperty,ye=Object.defineProperties,Be=Object.getOwnPropertyDescriptor,Ne=Object.getOwnPropertyDescriptors,Ae=Object.getOwnPropertyNames,ie=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable;var ae=(n,e,r)=>e in n?V(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r,me=(n,e)=>{for(var r in e||={})ue.call(e,r)&&ae(n,r,e[r]);if(ie)for(var r of ie(e))Re.call(e,r)&&ae(n,r,e[r]);return n},le=(n,e)=>ye(n,Ne(e));var Y=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),T=(n,e)=>{for(var r in e)V(n,r,{get:e[r],enumerable:!0})},Se=(n,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Ae(e))!ue.call(n,o)&&o!==r&&V(n,o,{get:()=>e[o],enumerable:!(t=Be(e,o))||t.enumerable});return n};var Pe=n=>Se(V({},"__esModule",{value:!0}),n);var fe=Y((qe,se)=>{"use strict";var _=2/(1+Math.sqrt(5));se.exports=Fe;function Fe(n,e,r,t,o,i){for(var a,u,l=0,s=r-_*(r-e),c=e+_*(r-e),h=n(s),f=n(c),m=n(e),b=n(r),w=e,M=r;++l<o&&Math.abs(r-e)>t;)f>h?(r=c,c=s,f=h,s=r-_*(r-e),h=n(s)):(e=s,s=c,h=f,c=e+_*(r-e),f=n(c));return a=.5*(r+e),u=.5*(h+f),i&&(i.iterations=l,i.argmin=a,i.minimum=u,i.converged=!0),isNaN(f)||isNaN(h)||l===o?(i&&(i.converged=!1),NaN):m<u?w:b<u?M:a}});var he=Y((Ue,ce)=>{"use strict";ce.exports=He;function He(n,e,r,t,o,i,a){var u,l,s,c,h,f,m;for(c=1,h=r,f=r,s=l=u=e(r);!m&&isFinite(t)&&!isNaN(t);)if(++c,m=!0,l<=s&&(s=l,h=Math.max(o,h-t),l=e(h),m=!1),u<=s&&(s=u,f=Math.min(i,f+t),u=e(f),m=!1),s=Math.min(s,l,u),(l===s&&h===o||u===s&&f===i)&&(m=!0),t*=c<4?2:Math.exp(c*.5),!isFinite(t))return n[0]=-1/0,n[1]=1/0,n;return n[0]=h,n[1]=f,n}});var pe=Y((Le,be)=>{"use strict";var Te=fe(),Ce=he(),S=[0,0];be.exports=function(e,r,t){r=r||{};var o,i=r.tolerance===void 0?1e-8:r.tolerance,a=r.initialIncrement===void 0?1:r.initialIncrement,u=r.lowerBound===void 0?-1/0:r.lowerBound,l=r.upperBound===void 0?1/0:r.upperBound,s=r.maxIterations===void 0?100:r.maxIterations;if(t&&(t.iterations=0,t.argmin=NaN,t.minimum=1/0,t.converged=!1),isFinite(l)&&isFinite(u))S[0]=u,S[1]=l;else if(r.guess===void 0?u>-1/0?o=l<1/0?.5*(u+l):u:o=l<1/0?l:0:o=r.guess,Ce(S,e,o,a,u,l,s),isNaN(S[0])||isNaN(S[1]))return NaN;return Te(e,S[0],S[1],i,s,t)}});var we=Y((ke,L)=>{var ge=7,de=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23],De=607/128,U=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Me(n){if(n<0)return Number("0/0");for(var e=U[0],r=U.length-1;r>0;--r)e+=U[r]/(n+r);var t=n+De+.5;return .5*Math.log(2*Math.PI)+(n+.5)*Math.log(t)-t+Math.log(e)-Math.log(n)}L.exports=function n(e){if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*n(1-e));if(e>100)return Math.exp(Me(e));e-=1;for(var r=de[0],t=1;t<ge+2;t++)r+=de[t]/(e+t);var o=e+ge+.5;return Math.sqrt(2*Math.PI)*Math.pow(o,e+.5)*Math.exp(-o)*r};L.exports.log=Me});var $e={};T($e,{ebisu2:()=>G,fmin:()=>J,gamma:()=>Q,initModel:()=>Ve,logsumexp:()=>$,math:()=>X,modelToPercentileDecay:()=>_e,predictRecall:()=>Ee,predictRecallApproximate:()=>Ye,rescaleHalflife:()=>Ze,updateRecall:()=>Xe});var G={};T(G,{customizeMath:()=>Ge,defaultModel:()=>je,modelToPercentileDecay:()=>Ie,predictRecall:()=>z,rescaleHalflife:()=>oe,updateRecall:()=>te});var J={};T(J,{fmin:()=>y});var y=pe();var Q={};T(Q,{gamma:()=>C,gammaln:()=>E});var C=we(),E=C.log;var $={};T($,{logsumexp:()=>P,sumexp:()=>Z});var X={};T(X,{exceedsThresholdLeft:()=>ne,kahanSum:()=>D,logNChooseK:()=>ee,logspace:()=>k,sum:()=>Ke});function Ke(n){return n.reduce((e,r)=>e+r,0)}function D(n){let e=0,r=0;for(let t of n){let o=t-r,i=e+o;r=i-e-o,e=i}return e}function k(n,e,r){let t=r-1,o=(e-n)/t,i=new Array(r),a=n;i[0]=10**a;for(var u=1;u<t;u++)a+=o,i[u]=10**a;return i[t]=10**e,i}function ee(n,e){return E(n+1)-E(e+1)-E(n-e+1)}function ne(n,e){let r=[],t=0;for(let o=n.length-1;o>=0;--o)t+=n[o],r.push(t>e);return r.reverse(),r}function P(n,e){let r=Math.max(...n),t=D(n.map((o,i)=>{var a;return Math.exp(o-r)*((a=e==null?void 0:e[i])!=null?a:1)}));if(t<0)throw new Error("s must be positive");return Math.log(t)+r}function Z(n,e){let r=Math.max(...n),t=D(n.map((o,i)=>{var a;return Math.exp(o-r)*((a=e==null?void 0:e[i])!=null?a:1)}));if(t<0)throw new Error("s must be positive");return t*Math.exp(r)}var ve=new Map;function W(n){let e=ve.get(n);return e!==void 0||(e=E(n),ve.set(n,e)),e}function Oe(n,e,r){return E(n)-E(n+r)+W(e+r)-W(e)}var A=(n,e)=>W(n)+W(e)-W(n+e),O=(n,e)=>E(n)+E(e)-E(n+e),K=(n,e)=>C(n)*C(e)/C(n+e);function We(n,e){return-A(1+n-e,1+e)-Math.log(n+1)}function Ge(n){let e={betaln:A,betafn:K};return n.betaln&&(A=n.betaln),n.betafn&&(K=n.betafn),e}function xe(n,e){var r=n*(1-n)/e-1,t=n*r,o=(1-n)*r;return[t,o]}function z(n,e,r=!1){let[t,o,i]=n,a=e/i,u=Oe(t+a,t,o);return r?Math.exp(u):u}function te(n,e,r,t,o,i=!0,a,u){if(0>e||e>r||r<1)throw new Error("0 <= successes and successes <= total and 1 <= total must be true");if(r===1)return re(n,e,t,o,i,a,u);if(!(e===Math.trunc(e)&&r===Math.trunc(r)))throw new Error("expecting integer successes and total");let[l,s,c]=n,h=t/c,f=r-e,m=[];for(let x=0;x<=f;x++)m.push(We(f,x));function b(x,g){let p=[];for(let d=0;d<=f;d++)p.push(m[d]+A(l+h*(e+d)+x*h*g,s));let I=[];for(let d=0;d<=f;d++)I.push(Math.pow(-1,d));return P(p,I)}let w=b(0,0),M;if(i){let x=Math.log(.5),g=d=>b(1,d)-w-x,p={},I=y(d=>Math.abs(g(d)),{},p);if(!("converged"in p)||!p.converged)throw new Error("failed to converge");M=I,a=M*t}a||(a=c),M=a/t;let B=b(1,M)-w,N=Math.exp(B),v=Math.exp(b(2,M)-w);if(N<=0)throw new Error("negative mean encountered");if(v<=0)throw new Error("negative 2nd moment encountered");let R=Math.exp(2*B),F=v-R;if(F<=0)throw new Error("negative variance encountered");let[q,H]=xe(N,F);return[q,H,a]}function re(n,e,r,t,o=!0,i,a=!1){if(!(0<=e&&e<=1))throw new Error("expecting result between 0 and 1 inclusive");let[u,l,s]=n,c=e>.5,h=c?e:1-e;t===void 0&&(t=1-h);let f=r/s,[m,b]=c?[h-t,t]:[t-h,1-t],w=m*K(u+f,l)+b*(K(u,l)||0),M=a?P([O(u+f,l),O(u,l)||-1/0],[m,b]):0;function B(g,p){let I=m*K(u+f+g*f*p,l);return b!==0&&(I+=b*K(u+g*f*p,l)),I/w}function N(g,p){return b!==0?P([O(u+f+g*f*p,l),O(u+g*f*p,l)],[m,b])-M:Math.log(m)+O(u+f+g*f*p,l)-M}let v;if(o){let g={},p;if(a){let I=Math.log(.5);p=y(d=>Math.abs(N(1,d)-I),{lowerBound:0},g)}else p=y(I=>Math.abs(B(1,I)-.5),{lowerBound:0},g);if(!("converged"in g)||!g.converged){if(!a)return console.log("TRYING BACKUP"),re(n,e,r,t,o,i,!a);throw console.error(g,{prior:n,result:e,tnow:r,q0:t,rebalance:o,tback:i}),new Error("failed to converge")}v=p,i=v*r}else i||(i=s),v=i/r;let R=a?Math.exp(N(1,v)):B(1,v),q=(a?Math.exp(N(2,v)):B(2,v))-R*R,[H,x]=xe(R,q);if(H<=0||x<=0)throw new Error("newAlpha and newBeta must be greater than zero");if(!(H>0&&x>0&&isFinite(H)&&isFinite(x))){if(!a)return re(n,e,r,t,o,i,!a);throw new Error("newAlpha and newBeta must be finite and greater than zero")}return[H,x,i]}function je(n,e=4,r=e){return[e,r,n]}function Ie(n,e=.5,r=1e-4){if(e<0||e>1)throw new Error("percentiles must be between (0, 1) exclusive");let[t,o,i]=n,a=A(t,o),u=Math.log(e);function l(h){let f=A(t+h,o)-a;return Math.abs(f-u)}let s={},c=y(l,{lowerBound:0,tolerance:r},s);if(!("converged"in s)||!s.converged)throw new Error("failed to converge");return c*i}function oe(n,e=1,r){let[t,o,i]=n,a=Ie(n,.5,r),u=a/i,l=A(t,o),s=A(t+2*u,o)-l,h=1/(8*Math.exp(s)-2)-.5;if(h<=0)throw new Error("non-positive alpha, beta encountered");return[h,h,a*e]}function Ve({firstHalflife:n,lastHalflife:e=1e4*n,firstWeight:r=.9,numAtoms:t=5,initialAlphaBeta:o=2}){if(!(isFinite(n)&&n>0))throw new Error("expecting positive firstHalflife");let i={},a=y(c=>{let h=0;for(let f=0;f<t;f++)h+=r*c**f;return Math.abs(h-1)},{lowerBound:.001,guess:.5,tolerance:1e-10,maxIterations:1e3},i);if(!(i.converged&&isFinite(a)&&0<a&&a<1))throw new Error("unable to initialize: "+i);let u=[];for(let c=0;c<t;c++)u.push(r*a**c);let l=D(u),s=k(Math.log10(n),Math.log10(e),t);return u.map((c,h)=>({log2weight:Math.log2(c/l),alpha:o,beta:o,time:s[h]}))}var j=Math.log(2);function Ee(n,e){let r=n.map(o=>j*o.log2weight+z([o.alpha,o.beta,o.time],e)),t=Z(r);if(!(isFinite(t)&&0<=t&&t<=1))throw new Error("unexpected result");return t}function Ye(n,e){return Z(n.map(r=>j*(r.log2weight-e/r.time)))}function _e(n,e=.5){if(!(0<e&&e<1))throw new Error("percentile \u2208 (0, 1)");let r={},t=y(o=>Math.abs(e-Ee(n,o)),{lowerBound:.01,guess:n[0].time},r);if(!r.converged)throw new Error("failed to converge");return t}function Je(n,e,r,t){let o=n>=.5;return Math.log(o?(e-r)*t+r:(r-e)*t+(1-r))}function Qe(n,e,r){return ee(e,n)+n*Math.log(r)+(e-n)*Math.log(1-r)}function Xe({model:n,successes:e,total:r=1,elapsedTime:t,q0:o=1-Math.max(e,1-e),updateThreshold:i=.9,weightThreshold:a=.9}){if(!(r===Math.floor(r)&&r>=1&&0<=e&&e<=r))throw new Error("total must be positive integer and successes \u2208 [0, total]");let u=n.map(m=>te([m.alpha,m.beta,m.time],e,r,t,o)),l=n.map(m=>z([m.alpha,m.beta,m.time],t,!0)),s;if(r===1){let m=Math.max(e,1-e);s=l.map(b=>Je(e,m,o,b))}else{if(e!==Math.floor(e))throw new Error("total>1 implies successes is integer");s=l.map(m=>Qe(e,r,m))}if(!s.every(m=>m<0))throw new Error("all log-probabilities must be negative");let c=[],h=ne(n.map(m=>2**m.log2weight),a);for(let[m,b]of n.entries()){let w=u[m],M=h[m],B=s[m],N=b.time,R=w[2]/N,F=b.log2weight+B/j;R>i||M?c.push({alpha:w[0],beta:w[1],time:w[2],log2weight:F}):c.push(le(me({},b),{log2weight:F}))}let f=P(c.map(m=>m.log2weight*j))/j;for(let m of c)m.log2weight-=f;return c}function Ze(n,e,r){if(e<=0)throw new Error("scale > 0");return n.map(t=>{let o=oe([t.alpha,t.beta,t.time],e,r);return{alpha:o[0],beta:o[1],time:o[2],log2weight:t.log2weight}})}return Pe($e);})();
//# sourceMappingURL=ebisu.min.js.map
