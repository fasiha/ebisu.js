var ae=Object.defineProperty,Ie=Object.defineProperties;var Ee=Object.getOwnPropertyDescriptors;var oe=Object.getOwnPropertySymbols;var ye=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable;var ie=(r,e,n)=>e in r?ae(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n,ue=(r,e)=>{for(var n in e||={})ye.call(e,n)&&ie(r,n,e[n]);if(oe)for(var n of oe(e))Be.call(e,n)&&ie(r,n,e[n]);return r},me=(r,e)=>Ie(r,Ee(e));var j=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),K=(r,e)=>{for(var n in e)ae(r,n,{get:e[n],enumerable:!0})};var se=j((je,le)=>{"use strict";var V=2/(1+Math.sqrt(5));le.exports=Ne;function Ne(r,e,n,t,o,i){for(var a,u,l=0,s=n-V*(n-e),c=e+V*(n-e),h=r(s),f=r(c),m=r(e),b=r(n),w=e,M=n;++l<o&&Math.abs(n-e)>t;)f>h?(n=c,c=s,f=h,s=n-V*(n-e),h=r(s)):(e=s,s=c,h=f,c=e+V*(n-e),f=r(c));return a=.5*(n+e),u=.5*(h+f),i&&(i.iterations=l,i.argmin=a,i.minimum=u,i.converged=!0),isNaN(f)||isNaN(h)||l===o?(i&&(i.converged=!1),NaN):m<u?w:b<u?M:a}});var ce=j((Ve,fe)=>{"use strict";fe.exports=Ae;function Ae(r,e,n,t,o,i,a){var u,l,s,c,h,f,m;for(c=1,h=n,f=n,s=l=u=e(n);!m&&isFinite(t)&&!isNaN(t);)if(++c,m=!0,l<=s&&(s=l,h=Math.max(o,h-t),l=e(h),m=!1),u<=s&&(s=u,f=Math.min(i,f+t),u=e(f),m=!1),s=Math.min(s,l,u),(l===s&&h===o||u===s&&f===i)&&(m=!0),t*=c<4?2:Math.exp(c*.5),!isFinite(t))return r[0]=-1/0,r[1]=1/0,r;return r[0]=h,r[1]=f,r}});var be=j((Ye,he)=>{"use strict";var Re=se(),Se=ce(),S=[0,0];he.exports=function(e,n,t){n=n||{};var o,i=n.tolerance===void 0?1e-8:n.tolerance,a=n.initialIncrement===void 0?1:n.initialIncrement,u=n.lowerBound===void 0?-1/0:n.lowerBound,l=n.upperBound===void 0?1/0:n.upperBound,s=n.maxIterations===void 0?100:n.maxIterations;if(t&&(t.iterations=0,t.argmin=NaN,t.minimum=1/0,t.converged=!1),isFinite(l)&&isFinite(u))S[0]=u,S[1]=l;else if(n.guess===void 0?u>-1/0?o=l<1/0?.5*(u+l):u:o=l<1/0?l:0:o=n.guess,Se(S,e,o,a,u,l,s),isNaN(S[0])||isNaN(S[1]))return NaN;return Re(e,S[0],S[1],i,s,t)}});var Me=j((_e,$)=>{var pe=7,ge=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23],Pe=607/128,Z=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function de(r){if(r<0)return Number("0/0");for(var e=Z[0],n=Z.length-1;n>0;--n)e+=Z[n]/(r+n);var t=r+Pe+.5;return .5*Math.log(2*Math.PI)+(r+.5)*Math.log(t)-t+Math.log(e)-Math.log(r)}$.exports=function r(e){if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*r(1-e));if(e>100)return Math.exp(de(e));e-=1;for(var n=ge[0],t=1;t<pe+2;t++)n+=ge[t]/(e+t);var o=e+pe+.5;return Math.sqrt(2*Math.PI)*Math.pow(o,e+.5)*Math.exp(-o)*n};$.exports.log=de});var J={};K(J,{customizeMath:()=>Ce,defaultModel:()=>De,modelToPercentileDecay:()=>xe,predictRecall:()=>_,rescaleHalflife:()=>te,updateRecall:()=>re});var X={};K(X,{fmin:()=>y});var y=be();var z={};K(z,{gamma:()=>T,gammaln:()=>E});var T=Me(),E=T.log;var ee={};K(ee,{logsumexp:()=>P,sumexp:()=>Y});var k={};K(k,{exceedsThresholdLeft:()=>L,kahanSum:()=>C,logNChooseK:()=>U,logspace:()=>q,sum:()=>Fe});function Fe(r){return r.reduce((e,n)=>e+n,0)}function C(r){let e=0,n=0;for(let t of r){let o=t-n,i=e+o;n=i-e-o,e=i}return e}function q(r,e,n){let t=n-1,o=(e-r)/t,i=new Array(n),a=r;i[0]=10**a;for(var u=1;u<t;u++)a+=o,i[u]=10**a;return i[t]=10**e,i}function U(r,e){return E(r+1)-E(e+1)-E(r-e+1)}function L(r,e){let n=[],t=0;for(let o=r.length-1;o>=0;--o)t+=r[o],n.push(t>e);return n.reverse(),n}function P(r,e){let n=Math.max(...r),t=C(r.map((o,i)=>{var a;return Math.exp(o-n)*((a=e==null?void 0:e[i])!=null?a:1)}));if(t<0)throw new Error("s must be positive");return Math.log(t)+n}function Y(r,e){let n=Math.max(...r),t=C(r.map((o,i)=>{var a;return Math.exp(o-n)*((a=e==null?void 0:e[i])!=null?a:1)}));if(t<0)throw new Error("s must be positive");return t*Math.exp(n)}var we=new Map;function W(r){let e=we.get(r);return e!==void 0||(e=E(r),we.set(r,e)),e}function He(r,e,n){return E(r)-E(r+n)+W(e+n)-W(e)}var A=(r,e)=>W(r)+W(e)-W(r+e),O=(r,e)=>E(r)+E(e)-E(r+e),D=(r,e)=>T(r)*T(e)/T(r+e);function Te(r,e){return-A(1+r-e,1+e)-Math.log(r+1)}function Ce(r){let e={betaln:A,betafn:D};return r.betaln&&(A=r.betaln),r.betafn&&(D=r.betafn),e}function ve(r,e){var n=r*(1-r)/e-1,t=r*n,o=(1-r)*n;return[t,o]}function _(r,e,n=!1){let[t,o,i]=r,a=e/i,u=He(t+a,t,o);return n?Math.exp(u):u}function re(r,e,n,t,o,i=!0,a,u){if(0>e||e>n||n<1)throw new Error("0 <= successes and successes <= total and 1 <= total must be true");if(n===1)return ne(r,e,t,o,i,a,u);if(!(e===Math.trunc(e)&&n===Math.trunc(n)))throw new Error("expecting integer successes and total");let[l,s,c]=r,h=t/c,f=n-e,m=[];for(let x=0;x<=f;x++)m.push(Te(f,x));function b(x,g){let p=[];for(let d=0;d<=f;d++)p.push(m[d]+A(l+h*(e+d)+x*h*g,s));let I=[];for(let d=0;d<=f;d++)I.push(Math.pow(-1,d));return P(p,I)}let w=b(0,0),M;if(i){let x=Math.log(.5),g=d=>b(1,d)-w-x,p={},I=y(d=>Math.abs(g(d)),{},p);if(!("converged"in p)||!p.converged)throw new Error("failed to converge");M=I,a=M*t}a||(a=c),M=a/t;let B=b(1,M)-w,N=Math.exp(B),v=Math.exp(b(2,M)-w);if(N<=0)throw new Error("negative mean encountered");if(v<=0)throw new Error("negative 2nd moment encountered");let R=Math.exp(2*B),F=v-R;if(F<=0)throw new Error("negative variance encountered");let[Q,H]=ve(N,F);return[Q,H,a]}function ne(r,e,n,t,o=!0,i,a=!1){if(!(0<=e&&e<=1))throw new Error("expecting result between 0 and 1 inclusive");let[u,l,s]=r,c=e>.5,h=c?e:1-e;t===void 0&&(t=1-h);let f=n/s,[m,b]=c?[h-t,t]:[t-h,1-t],w=m*D(u+f,l)+b*(D(u,l)||0),M=a?P([O(u+f,l),O(u,l)||-1/0],[m,b]):0;function B(g,p){let I=m*D(u+f+g*f*p,l);return b!==0&&(I+=b*D(u+g*f*p,l)),I/w}function N(g,p){return b!==0?P([O(u+f+g*f*p,l),O(u+g*f*p,l)],[m,b])-M:Math.log(m)+O(u+f+g*f*p,l)-M}let v;if(o){let g={},p;if(a){let I=Math.log(.5);p=y(d=>Math.abs(N(1,d)-I),{lowerBound:0},g)}else p=y(I=>Math.abs(B(1,I)-.5),{lowerBound:0},g);if(!("converged"in g)||!g.converged){if(!a)return console.log("TRYING BACKUP"),ne(r,e,n,t,o,i,!a);throw console.error(g,{prior:r,result:e,tnow:n,q0:t,rebalance:o,tback:i}),new Error("failed to converge")}v=p,i=v*n}else i||(i=s),v=i/n;let R=a?Math.exp(N(1,v)):B(1,v),Q=(a?Math.exp(N(2,v)):B(2,v))-R*R,[H,x]=ve(R,Q);if(H<=0||x<=0)throw new Error("newAlpha and newBeta must be greater than zero");if(!(H>0&&x>0&&isFinite(H)&&isFinite(x))){if(!a)return ne(r,e,n,t,o,i,!a);throw new Error("newAlpha and newBeta must be finite and greater than zero")}return[H,x,i]}function De(r,e=4,n=e){return[e,n,r]}function xe(r,e=.5,n=1e-4){if(e<0||e>1)throw new Error("percentiles must be between (0, 1) exclusive");let[t,o,i]=r,a=A(t,o),u=Math.log(e);function l(h){let f=A(t+h,o)-a;return Math.abs(f-u)}let s={},c=y(l,{lowerBound:0,tolerance:n},s);if(!("converged"in s)||!s.converged)throw new Error("failed to converge");return c*i}function te(r,e=1,n){let[t,o,i]=r,a=xe(r,.5,n),u=a/i,l=A(t,o),s=A(t+2*u,o)-l,h=1/(8*Math.exp(s)-2)-.5;if(h<=0)throw new Error("non-positive alpha, beta encountered");return[h,h,a*e]}function ke({firstHalflife:r,lastHalflife:e=1e4*r,firstWeight:n=.9,numAtoms:t=5,initialAlphaBeta:o=2}){if(!(isFinite(r)&&r>0))throw new Error("expecting positive firstHalflife");let i={},a=y(c=>{let h=0;for(let f=0;f<t;f++)h+=n*c**f;return Math.abs(h-1)},{lowerBound:.001,guess:.5,tolerance:1e-10,maxIterations:1e3},i);if(!(i.converged&&isFinite(a)&&0<a&&a<1))throw new Error("unable to initialize: "+i);let u=[];for(let c=0;c<t;c++)u.push(n*a**c);let l=C(u),s=q(Math.log10(r),Math.log10(e),t);return u.map((c,h)=>({log2weight:Math.log2(c/l),alpha:o,beta:o,time:s[h]}))}var G=Math.log(2);function Ke(r,e){let n=r.map(o=>G*o.log2weight+_([o.alpha,o.beta,o.time],e)),t=Y(n);if(!(isFinite(t)&&0<=t&&t<=1))throw new Error("unexpected result");return t}function en(r,e){return Y(r.map(n=>G*(n.log2weight-e/n.time)))}function nn(r,e=.5){if(!(0<e&&e<1))throw new Error("percentile \u2208 (0, 1)");let n={},t=y(o=>Math.abs(e-Ke(r,o)),{lowerBound:.01,guess:r[0].time},n);if(!n.converged)throw new Error("failed to converge");return t}function Oe(r,e,n,t){let o=r>=.5;return Math.log(o?(e-n)*t+n:(n-e)*t+(1-n))}function We(r,e,n){return U(e,r)+r*Math.log(n)+(e-r)*Math.log(1-n)}function rn({model:r,successes:e,total:n=1,elapsedTime:t,q0:o=1-Math.max(e,1-e),updateThreshold:i=.9,weightThreshold:a=.9}){if(!(n===Math.floor(n)&&n>=1&&0<=e&&e<=n))throw new Error("total must be positive integer and successes \u2208 [0, total]");let u=r.map(m=>re([m.alpha,m.beta,m.time],e,n,t,o)),l=r.map(m=>_([m.alpha,m.beta,m.time],t,!0)),s;if(n===1){let m=Math.max(e,1-e);s=l.map(b=>Oe(e,m,o,b))}else{if(e!==Math.floor(e))throw new Error("total>1 implies successes is integer");s=l.map(m=>We(e,n,m))}if(!s.every(m=>m<0))throw new Error("all log-probabilities must be negative");let c=[],h=L(r.map(m=>2**m.log2weight),a);for(let[m,b]of r.entries()){let w=u[m],M=h[m],B=s[m],N=b.time,R=w[2]/N,F=b.log2weight+B/G;R>i||M?c.push({alpha:w[0],beta:w[1],time:w[2],log2weight:F}):c.push(me(ue({},b),{log2weight:F}))}let f=P(c.map(m=>m.log2weight*G))/G;for(let m of c)m.log2weight-=f;return c}function tn(r,e,n){if(e<=0)throw new Error("scale > 0");return r.map(t=>{let o=te([t.alpha,t.beta,t.time],e,n);return{alpha:o[0],beta:o[1],time:o[2],log2weight:t.log2weight}})}export{J as ebisu2,X as fmin,z as gamma,ke as initModel,ee as logsumexp,k as math,nn as modelToPercentileDecay,Ke as predictRecall,en as predictRecallApproximate,tn as rescaleHalflife,rn as updateRecall};
//# sourceMappingURL=ebisu.min.mjs.map
